# Баги: Аутентификация и управление пользователями

## ✅ BUG-002: Отсутствует валидация уникальности email при создании пользователя - ИСПРАВЛЕНО

**Приоритет**: High
**Модуль**: Управление пользователями
**Статус**: Исправлено

### Описание
При создании пользователя система может пропускать email вида `marcia.heidenreich@aaa` для изменения, но не ясно, работает ли валидация уникальности при создании.

### Шаги для воспроизведения
1. Создать нового пользователя с email `test@example.com`
2. Попытаться создать еще одного пользователя с тем же email `test@example.com`

### Ожидаемое поведение
- Система должна показать ошибку валидации о том, что email уже используется

### Фактическое поведение
- Требуется проверка на практике

### Файлы для проверки
- `app/Http/Requests/Admin/User/StoreRequest.php` (строка 29 - есть правило `unique:users,email`)
- `app/Http/Requests/Admin/User/UpdateRequest.php` (строки 32-38)

### Предполагаемая причина
В `StoreRequest.php` есть правило `unique:users,email` (строка 29), но может быть проблема с обработкой ошибок валидации на фронтенде или некорректная работа правила.

### Решение
1. Проверить, правильно ли работает правило `unique:users,email` в `StoreRequest`
2. Проверить, отображаются ли ошибки валидации на фронтенде
3. Протестировать создание пользователя с дублирующимся email

### Исправление (выполнено)
Валидация уникальности email работает корректно:
- В `app/Http/Requests/Admin/User/StoreRequest.php` (строка 29): правило `unique:users,email` работает правильно
- Пользовательское сообщение об ошибке (строка 129): `'email.unique' => 'Пользователь с таким email уже существует.'`
- Ошибки валидации корректно отображаются на фронтенде через Inertia.js

---

## ✅ BUG-003: Красная звездочка возле роли при создании пользователя, но пользователь не создается - ИСПРАВЛЕНО

**Приоритет**: Critical
**Модуль**: Управление пользователями
**Статус**: Исправлено

### Описание
При создании пользователя в админ-панели возле поля "Роль" появляется красная звездочка (индикатор ошибки), но пользователь не создается. В ответе сервера код 200, ошибок в консоли нет.

### Шаги для воспроизведения
1. Перейти в раздел создания пользователя (`/admin/users/create`)
2. Заполнить форму создания пользователя
3. Выбрать роль
4. Нажать "Создать"
5. Проверить консоль браузера (Network tab)

### Ожидаемое поведение
- Пользователь должен быть создан
- При наличии ошибок валидации должны отображаться сообщения об ошибках

### Фактическое поведение
- Красная звездочка возле роли
- Пользователь не создается
- В ответе сервера код 200
- Ошибок в консоли нет

### Файлы для проверки
- `app/Http/Controllers/Admin/UsersController.php` (метод `store`)
- `app/Http/Requests/Admin/User/StoreRequest.php`
- `resources/js/Pages/Admin/Users/Create.vue`
- JavaScript консоль браузера

### Предполагаемая причина
1. Проблема с валидацией роли на клиенте или сервере
2. Ошибка валидации не передается корректно на фронтенд
3. Проблема с обработкой формы на фронтенде
4. Возможна проблема с CSRF токеном
5. Проблема с обработкой ответа сервера в Inertia.js

### Решение
1. Проверить валидацию роли в `StoreRequest`
2. Проверить обработку ошибок валидации в `UsersController::store()`
3. Проверить обработку ответа сервера в Vue компоненте `Create.vue`
4. Проверить консоль браузера на наличие скрытых ошибок JavaScript
5. Проверить Network tab для просмотра полного ответа сервера (проверить тело ответа)
6. Проверить, правильно ли обрабатываются ошибки валидации в Inertia.js

### Исправление (выполнено)
**Причина:** Валидация требовала поля, которые не предоставлялись формой:
- `kubgtu_id` был `required_if:role,student`, но автоматически генерируется в контроллере
- `faculty_id` был `required_if:role,student`, но не было в форме
- `group` был `required_if:role,student`, но не было в форме
- `company_name` был `required_if:role,partner`, но не было в форме
- `contact_person` был `required_if:role,partner`, но не было в форме

**Исправления в `app/Http/Requests/Admin/User/StoreRequest.php`:**
1. Изменено `kubgtu_id` с `required_if:role,student` на `nullable` (строки 34-40)
2. Изменено `course` с `required_if:role,student` на `nullable` (строки 41-45)
3. Изменено `faculty_id` с `required_if:role,student` на `nullable` (строки 55-59)
4. Изменено `group` с `required_if:role,student` на `nullable` (строки 60-64)
5. Изменено `company_name` с `required_if:role,partner` на `nullable` (строки 77-81)
6. Изменено `contact_person` с `required_if:role,partner` на `nullable` (строки 99-103)
7. Удалены соответствующие `required_if` сообщения об ошибках

Теперь форма создания пользователя работает с базовыми полями. Профиль-специфичные поля могут быть заполнены позже при редактировании.
