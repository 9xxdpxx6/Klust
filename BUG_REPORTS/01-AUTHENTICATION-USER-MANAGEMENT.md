# Баги: Аутентификация и управление пользователями

## BUG-001: Обновление пароля при совпадении со старым

**Приоритет**: Medium  
**Модуль**: Управление пользователями / Профиль

### Описание
При изменении пароля пользователя, если новый пароль совпадает со старым, система все равно обновляет пароль в базе данных (выполняет повторное хеширование).

### Шаги для воспроизведения
1. Авторизоваться в системе (роль: admin)
2. Перейти в раздел управления пользователями (`/admin/users`)
3. Выбрать любого пользователя и нажать "Редактировать"
4. Ввести новый пароль (например: `password123`)
5. Сохранить изменения
6. Снова открыть форму редактирования того же пользователя
7. Ввести тот же пароль (`password123`)
8. Сохранить изменения

### Ожидаемое поведение
- Система должна проверить, совпадает ли новый пароль со старым
- Если пароли совпадают, обновление пароля должно быть пропущено
- Пароль не должен перехешироваться без необходимости

### Фактическое поведение
- Пароль обновляется и перехешируется даже если он идентичен старому
- Это приводит к ненужным операциям в базе данных
- Может вызвать путаницу при логировании изменений

### Файлы для проверки
- `app/Services/UserService.php` (метод `updateUser`, строки 59-90)
- `app/Http/Controllers/Admin/UsersController.php` (метод `update`, строки 204-239)
- `app/Http/Requests/Admin/User/UpdateRequest.php`
- `app/Services/UserService.php` (метод `updateStudentProfile`, строки 216-250)
- `app/Services/UserService.php` (метод `updatePartnerProfile`, строки 255-295)

### Предполагаемая причина
В методе `updateUser` (и других методах обновления профиля) отсутствует проверка на совпадение нового пароля со старым:

```70:72:app/Services/UserService.php
// Update password if provided
if (isset($data['password']) && ! empty($data['password'])) {
    $userUpdate['password'] = Hash::make($data['password']);
}
```

Аналогичная проблема в контроллере:

```216:218:app/Http/Controllers/Admin/UsersController.php
// Обновляем пароль только если он указан
if ($request->filled('password')) {
    $updateData['password'] = Hash::make($request->password);
}
```

### Решение
Добавить проверку совпадения пароля перед обновлением:

1. Использовать `Hash::check()` для сравнения нового пароля со старым
2. Обновлять пароль только если он отличается от текущего
3. Применить исправление во всех методах обновления:
   - `UserService::updateUser()`
   - `UserService::updateStudentProfile()`
   - `UserService::updatePartnerProfile()`
   - `UsersController::update()`

### Пример исправления
```php
// Update password if provided and different from current
if (isset($data['password']) && !empty($data['password'])) {
    if (!Hash::check($data['password'], $user->password)) {
        $userUpdate['password'] = Hash::make($data['password']);
    }
}
```

---

## BUG-002: Отсутствует валидация уникальности email при создании пользователя

**Приоритет**: High  
**Модуль**: Управление пользователями

### Описание
При создании пользователя система может пропускать email вида `marcia.heidenreich@aaa` для изменения, но не ясно, работает ли валидация уникальности при создании.

### Шаги для воспроизведения
1. Создать нового пользователя с email `test@example.com`
2. Попытаться создать еще одного пользователя с тем же email `test@example.com`

### Ожидаемое поведение
- Система должна показать ошибку валидации о том, что email уже используется

### Фактическое поведение
- Требуется проверка

### Файлы для проверки
- `app/Http/Requests/Admin/User/StoreRequest.php`
- `app/Http/Requests/Admin/User/UpdateRequest.php` (строки 32-38)

### Предполагаемая причина
Возможно, отсутствует правило `unique` в `StoreRequest` или оно работает некорректно.

### Решение
Проверить наличие и корректность правила валидации уникальности email в `StoreRequest`.

---

## BUG-003: Красная звездочка возле роли при создании пользователя, но пользователь не создается

**Приоритет**: Critical  
**Модуль**: Управление пользователями

### Описание
При создании пользователя в админ-панели возле поля "Роль" появляется красная звездочка (индикатор ошибки), но пользователь не создается. В ответе сервера код 200, ошибок в консоли нет.

### Шаги для воспроизведения
1. Перейти в раздел создания пользователя (`/admin/users/create`)
2. Заполнить форму создания пользователя
3. Выбрать роль
4. Нажать "Создать"
5. Проверить консоль браузера (Network tab)

### Ожидаемое поведение
- Пользователь должен быть создан
- При наличии ошибок валидации должны отображаться сообщения об ошибках

### Фактическое поведение
- Красная звездочка возле роли
- Пользователь не создается
- В ответе сервера код 200
- Ошибок в консоли нет

### Файлы для проверки
- `app/Http/Controllers/Admin/UsersController.php` (метод `store`)
- `app/Http/Requests/Admin/User/StoreRequest.php`
- `resources/js/Pages/Admin/Users/Create.vue`
- JavaScript консоль браузера

### Предполагаемая причина
1. Проблема с валидацией роли на клиенте или сервере
2. Ошибка валидации не передается корректно на фронтенд
3. Проблема с обработкой формы на фронтенде
4. Возможна проблема с CSRF токеном

### Решение
1. Проверить валидацию роли в `StoreRequest`
2. Проверить обработку ошибок валидации в `UsersController::store()`
3. Проверить обработку ответа сервера в Vue компоненте `Create.vue`
4. Проверить консоль браузера на наличие скрытых ошибок JavaScript
5. Проверить Network tab для просмотра полного ответа сервера

