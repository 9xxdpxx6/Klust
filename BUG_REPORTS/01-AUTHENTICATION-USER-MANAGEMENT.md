# Баги: Аутентификация и управление пользователями

## BUG-013: Email валидация слишком слабая - принимает некорректные email адреса

**Приоритет**: High  
**Модуль**: Управление пользователями / Валидация

### Описание
Валидация email принимает некорректные email адреса, которые не имеют точки в доменной части. Например, `pidor@pidor` сохраняется, хотя это некорректный email адрес (должен быть как минимум `pidor@pidor.com`).

### Шаги для воспроизведения
1. Авторизоваться в системе (роль: admin)
2. Перейти в раздел создания пользователя (`/admin/users/create`)
3. Заполнить форму создания пользователя
4. В поле "Email" ввести `pidor@pidor` (или любой другой email без точки в домене)
5. Нажать "Создать"
6. Проверить, что пользователь создан с некорректным email

### Ожидаемое поведение
- Система должна показать ошибку валидации о том, что email имеет некорректный формат
- Email должен иметь доменное имя с точкой (например, `user@example.com`)

### Фактическое поведение
- Email `pidor@pidor` успешно сохраняется
- Валидация не проверяет наличие точки в доменной части email

### Файлы для проверки
- `app/Http/Requests/Admin/User/StoreRequest.php` (строка 29 - правило `'email'`)
- `app/Http/Requests/Admin/User/UpdateRequest.php` (строки 32-38)
- `app/Http/Requests/Auth/RegisterStudentRequest.php` (строка 29)
- `app/Http/Requests/Auth/RegisterPartnerRequest.php`
- Все Form Request классы, которые валидируют email

### Предполагаемая причина
Правило валидации `'email'` в Laravel по умолчанию использует стандарт RFC 5322, который может принимать некоторые некорректные форматы. Нужна более строгая валидация с использованием регулярного выражения или более строгих правил.

### Решение
1. **Добавить более строгую валидацию email** с использованием регулярного выражения:
   ```php
   'email' => [
       'required',
       'string',
       'email:rfc,dns', // Проверка RFC и DNS
       'max:255',
       'unique:users,email',
   ],
   ```
   Или использовать регулярное выражение для более строгой проверки:
   ```php
   'email' => [
       'required',
       'string',
       'regex:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/',
       'max:255',
       'unique:users,email',
   ],
   ```

2. **Применить исправление во всех Form Request классах**, которые валидируют email:
   - `app/Http/Requests/Admin/User/StoreRequest.php`
   - `app/Http/Requests/Admin/User/UpdateRequest.php`
   - `app/Http/Requests/Auth/RegisterStudentRequest.php`
   - `app/Http/Requests/Auth/RegisterPartnerRequest.php`
   - `app/Http/Requests/Student/Profile/UpdateRequest.php`
   - `app/Http/Requests/Partner/Profile/UpdateRequest.php`

3. **Добавить пользовательское сообщение об ошибке** для лучшей обратной связи

---

## BUG-014: Роль пользователя можно изменить при редактировании

**Приоритет**: High  
**Модуль**: Управление пользователями / Безопасность

### Описание
При редактировании пользователя можно изменить его роль через выпадающий список. Это может привести к проблемам с правами доступа и нарушению целостности данных.

### Шаги для воспроизведения
1. Авторизоваться в системе (роль: admin)
2. Перейти в раздел пользователей (`/admin/users`)
3. Выбрать любого пользователя и нажать "Редактировать"
4. Изменить роль пользователя (например, со "Студент" на "Партнер")
5. Сохранить изменения
6. Проверить, что роль изменилась

### Ожидаемое поведение
- Поле "Роль" должно быть **readonly** или **disabled** при редактировании
- Роль пользователя не должна изменяться после создания
- Если нужно изменить роль, это должно быть отдельной операцией с дополнительными проверками

### Фактическое поведение
- Поле "Роль" доступно для изменения через выпадающий список `Select`
- Роль может быть изменена при редактировании пользователя

### Файлы для проверки
- `resources/js/Pages/Admin/Users/Edit.vue` (строки 99-109 - поле роли)
- `app/Http/Requests/Admin/User/UpdateRequest.php` (строка 41 - валидация роли)
- `app/Http/Controllers/Admin/UsersController.php` (метод `update`)

### Предполагаемая причина
В форме редактирования пользователя поле роли не помечено как `disabled` или `readonly`. Также в контроллере и Form Request нет проверки на изменение роли.

### Решение
1. **В `resources/js/Pages/Admin/Users/Edit.vue`**:
   - Добавить `disabled` атрибут к компоненту `Select` для роли:
   ```vue
   <Select
       v-model="form.role"
       label="Роль"
       :options="roleOptions"
       optionLabel="label"
       optionValue="value"
       placeholder="Выберите роль"
       :error="errors.role"
       disabled
       required
   />
   ```
   Или сделать поле только для просмотра с текстовым отображением текущей роли

2. **В `app/Http/Requests/Admin/User/UpdateRequest.php`**:
   - Удалить или игнорировать поле `role` при обновлении
   - Добавить проверку, что роль не изменяется

3. **В `app/Http/Controllers/Admin/UsersController.php`** (метод `update`):
   - Не обновлять роль при редактировании пользователя
   - Или добавить отдельный метод для изменения роли с дополнительными проверками

### Альтернативное решение
Если изменение роли необходимо, создать отдельный функционал:
- Отдельная кнопка "Изменить роль" с подтверждением
- Отдельный маршрут и метод для изменения роли
- Дополнительные проверки и логирование изменения роли

---

## BUG-015: Неправильные отступы и структура в странице просмотра пользователя (Show.vue)

**Приоритет**: Medium  
**Модуль**: UI компоненты / Страницы админ-панели

### Описание
На странице просмотра пользователя (`/admin/users/{id}`) неправильная структура и отступы:
- Заголовок "Профиль пользователя: {name}" и кнопка редактирования находятся **внутри** блока "Основная информация"
- Дублируется заголовок "Основная информация"
- Неправильная иерархия элементов - заголовок и кнопка должны быть выше блока

### Шаги для воспроизведения
1. Авторизоваться в системе (роль: admin)
2. Перейти в раздел пользователей (`/admin/users`)
3. Выбрать любого пользователя и открыть его профиль (страница Show.vue)
4. Наблюдать за структурой страницы

### Ожидаемое поведение
- Заголовок "Профиль пользователя: {name}" и кнопка редактирования должны быть **выше** блока "Основная информация"
- Заголовок "Основная информация" должен быть один раз внутри своего блока
- Правильная иерархия: Breadcrumbs → Заголовок с кнопкой → Основная информация → Детали

### Фактическое поведение
- Заголовок и кнопка редактирования находятся **внутри** блока "Основная информация" (строка 43-52 внутри блока строк 27-134)
- Дублируется структура - есть заголовок "Основная информация" в строке 30, а затем еще заголовок "Профиль пользователя" в строке 44
- Неправильные отступы и визуальная иерархия

### Файлы для проверки
- `resources/js/Pages/Admin/Users/Show.vue` (строки 26-52)

### Предполагаемая причина
Структура HTML неправильно организована:
- Заголовок "Основная информация" в строке 30 находится в правильном месте
- Но заголовок "Профиль пользователя: {name}" и кнопка редактирования в строках 43-52 находятся **внутри** блока основной информации (внутри `<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">`)
- Это создает неправильную иерархию и визуальную структуру

### Решение
1. **Переместить блок с заголовком и кнопкой редактирования** выше блока "Основная информация":
   ```vue
   <!-- Хлебные крошки -->
   <div class="mb-6">...</div>
   
   <!-- Заголовок и кнопка редактирования -->
   <div class="flex justify-between items-center mb-6">
       <h1 class="text-2xl font-bold text-gray-900">Профиль пользователя: {{ user.name }}</h1>
       <Link :href="route('admin.users.edit', user.id)" ...>
           <i class="pi pi-pencil text-sm"></i>
       </Link>
   </div>
   
   <!-- Основная информация -->
   <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
       <div class="px-4 py-5 sm:px-6">
           <h3 class="text-lg leading-6 font-medium text-gray-900">Основная информация</h3>
           <p class="mt-1 max-w-2xl text-sm text-gray-500">Детальные данные пользователя</p>
       </div>
       <div class="border-t border-gray-200">
           <!-- Детали пользователя -->
       </div>
   </div>
   ```

2. **Удалить блок с заголовком и кнопкой** из строк 43-52, так как он будет выше

3. **Убрать закомментированный код** (строки 33-40), так как он больше не нужен

4. **Исправить структуру**: Заголовок и кнопка должны быть на том же уровне, что и блок "Основная информация", а не внутри него
