# Баги: Фильтры и статистика

## BUG-010: Ошибка "Cannot modify readonly property BaseFilter::$filters"

**Приоритет**: Critical  
**Модуль**: Фильтры / BaseFilter

### Описание
При работе с фильтрами возникает ошибка: "Cannot modify readonly property App\Filters\BaseFilter::$filters"

### Шаги для воспроизведения
1. Использовать любую страницу с фильтрами (например, список пользователей, кейсов и т.д.)
2. Применить фильтры
3. Ошибка может возникать при попытке модификации фильтров

### Ожидаемое поведение
- Фильтры должны работать корректно без ошибок
- Должна быть возможность применять и изменять фильтры

### Фактическое поведение
- Возникает ошибка PHP: "Cannot modify readonly property App\Filters\BaseFilter::$filters"
- Страница не работает или работает некорректно

### Файлы для проверки
- `app/Filters/BaseFilter.php` (строка 13)
- Все классы-наследники `BaseFilter`:
  - `app/Filters/CaseFilter.php`
  - `app/Filters/CaseApplicationFilter.php`
  - `app/Filters/UserFilter.php`
  - `app/Filters/TeamFilter.php`
  - `app/Filters/SkillFilter.php`

### Предполагаемая причина

В классе `BaseFilter` свойство `$filters` объявлено как `readonly`:

```13:13:app/Filters/BaseFilter.php
protected readonly array $filters;
```

Проблема возникает, если где-то в коде (в `BaseFilter` или в его наследниках) предпринимается попытка изменить это свойство после инициализации в конструкторе.

Конструктор устанавливает значение:
```15:18:app/Filters/BaseFilter.php
public function __construct(array $filters = [])
{
    $this->filters = $filters;
}
```

Если где-то в методе `apply()` или в других методах происходит попытка изменить `$this->filters`, это приведет к ошибке.

### Решение

1. **Проверить все использования `$this->filters`** в `BaseFilter` и его наследниках
2. Убедиться, что нигде не происходит попытки модификации этого свойства
3. Если нужно изменять фильтры, создать копию массива для работы

### Пример исправления

Если нужно работать с фильтрами внутри методов, использовать локальную переменную:

```php
protected function someMethod(): void
{
    // Использовать $this->filters только для чтения
    $filters = $this->filters; // копия для чтения
    
    // Если нужно модифицировать, использовать локальную переменную
    $modifiedFilters = $this->filters;
    // ... работа с $modifiedFilters
}
```

Или использовать методы `getFilter()` и `hasFilter()` вместо прямого доступа к `$this->filters`.

---

## BUG-011: Статистика показывает количество записей на странице вместо общего количества

**Приоритет**: High  
**Модуль**: Статистика / Дашборд

### Описание
В сводке (дашборде) статистика показывает количество записей на текущей странице (с учетом фильтрации и пагинации) вместо общего количества записей в базе данных.

Например:
- "Все пользователи" показывает 25 (количество на странице) вместо общего количества (например, 117)
- "Верифицированные" показывает количество на странице вместо общего количества
- "Студенты" показывает количество на странице вместо общего количества

### Шаги для воспроизведения
1. Авторизоваться в систему (роль: admin)
2. Перейти на дашборд (`/admin/dashboard`)
3. Проверить статистику в сводке
4. Применить фильтры или изменить количество записей на странице (например, выбрать "по 25", "по 10", "по 50")
5. Наблюдать за изменением статистики

### Ожидаемое поведение
- Статистика должна показывать **общее количество** записей в базе данных
- Фильтрация и пагинация не должны влиять на отображаемую статистику
- Статистика должна быть независима от текущей страницы и фильтров

### Фактическое поведение
- Статистика показывает количество записей на текущей странице
- При изменении количества записей на странице (10, 25, 50) статистика изменяется соответственно
- При фильтрации статистика показывает количество отфильтрованных записей на странице, а не общее количество

### Файлы для проверки
- `app/Services/DashboardService.php`
- `app/Http/Controllers/Admin/DashboardController.php`
- `resources/js/Pages/Admin/Dashboard.vue` (или аналогичные страницы дашборда)
- Методы получения статистики в сервисах

### Предполагаемая причина

1. **В `DashboardService` или контроллере** статистика берется из уже отфильтрованного и пагинированного запроса:
   ```php
   // НЕПРАВИЛЬНО - использует пагинированные данные
   $users = User::filter($filters)->paginate(25);
   $totalUsers = $users->count(); // Это вернет 25, а не общее количество
   ```

2. **Статистика вычисляется на основе коллекции**, которая уже ограничена пагинацией или фильтрацией

3. **Во Vue компоненте** статистика может браться из props пагинированных данных вместо отдельного запроса

### Решение

1. **Получать статистику отдельными запросами**, независимо от фильтрации и пагинации:
   ```php
   // ПРАВИЛЬНО - отдельный запрос для статистики
   $totalUsers = User::count();
   $verifiedUsers = User::whereNotNull('email_verified_at')->count();
   $students = User::whereHas('roles', function($q) {
       $q->where('name', 'student');
   })->count();
   ```

2. **В `DashboardService`** создать отдельные методы для получения статистики:
   - `getTotalUsersCount()` - общее количество пользователей
   - `getVerifiedUsersCount()` - количество верифицированных
   - `getStudentsCount()` - количество студентов
   - И т.д.

3. **Убедиться, что статистика не зависит от фильтров**, передаваемых для отображения списка

4. **Проверить Vue компонент** и убедиться, что статистика берется из правильных props

### Пример исправления

В `DashboardService`:
```php
public function getStatistics(): array
{
    return [
        'total_users' => User::count(),
        'verified_users' => User::whereNotNull('email_verified_at')->count(),
        'students' => User::whereHas('roles', function($q) {
            $q->where('name', 'student');
        })->count(),
        // ... другие статистики
    ];
}
```

И в контроллере:
```php
public function index(Request $request): Response
{
    // Статистика - отдельно, не зависит от фильтров
    $statistics = $this->dashboardService->getStatistics();
    
    // Список - с фильтрами и пагинацией
    $users = $this->getFilteredUsers($request);
    
    return Inertia::render('Admin/Dashboard', [
        'statistics' => $statistics,
        'users' => $users,
    ]);
}
```

---

## BUG-012: При фильтрации статистика всегда показывает 25 (или количество записей на странице)

**Приоритет**: High  
**Модуль**: Статистика / Фильтры

### Описание
Это уточнение BUG-011. При фильтрации и выборе отображать "по 25 (10, 50)" количество в статистике всегда будет соответствовать количеству записей на странице (25, 10, или 50), а не общему количеству.

### Решение
То же, что и для BUG-011 - статистика должна получаться отдельными запросами, независимо от пагинации и фильтрации.

